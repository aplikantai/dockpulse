// DockPulse SaaS - Multi-tenant Schema
// PR1: Multi-tenancy Foundation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== TENANCY ====================

model Tenant {
  id           String     @id @default(uuid())
  slug         String     @unique // subdomena: "firma1" -> firma1.dockpulse.com
  name         String

  // Branding
  logoUrl      String?
  primaryColor String     @default("#3B82F6")

  // Settings
  settings     Json       @default("{}")
  locale       String     @default("pl-PL")
  timezone     String     @default("Europe/Warsaw")

  // Plan/billing
  plan         TenantPlan @default(FREE)

  // Status
  isActive     Boolean    @default(true)

  // Relations
  memberships  Membership[]
  orders       Order[]
  customers    Customer[]
  products     Product[]
  auditEvents  AuditEvent[]
  clientUsers  ClientUser[]
  attachments  Attachment[]

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([slug])
}

enum TenantPlan {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

// ==================== USER (pracownik firmy) ====================

model User {
  id           String       @id @default(uuid())

  phone        String       @unique
  passwordHash String

  name         String
  email        String?
  avatarUrl    String?

  isActive     Boolean      @default(true)

  // Relations
  memberships  Membership[]
  refreshTokens RefreshToken[]
  createdOrders Order[]     @relation("CreatedByUser")
  assignedOrders Order[]    @relation("AssignedToUser")

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([phone])
}

// ==================== MEMBERSHIP (user <-> tenant) ====================

model Membership {
  id          String     @id @default(uuid())

  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  tenantId    String
  tenant      Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  role        TenantRole @default(MEMBER)
  permissions String[]   @default([])

  isActive    Boolean    @default(true)
  invitedAt   DateTime   @default(now())
  acceptedAt  DateTime?

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([userId])
}

enum TenantRole {
  OWNER   // Wlasciciel firmy
  ADMIN   // Administrator
  MANAGER // Manager
  MEMBER  // Pracownik
}

// ==================== REFRESH TOKEN ====================

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique // Hashed!
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

// ==================== AUDIT LOG ====================

model AuditEvent {
  id         String   @id @default(uuid())

  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId     String?
  action     String   // LOGIN, ORDER_CREATED, STATUS_CHANGED, etc.
  entityType String?  // Order, Customer, Product
  entityId   String?

  // Metadata (NIGDY PII!)
  metadata   Json     @default("{}")

  ipAddress  String?
  userAgent  String?

  createdAt  DateTime @default(now())

  @@index([tenantId, createdAt])
  @@index([entityType, entityId])
  @@index([userId, createdAt])
  @@index([action, createdAt])
}

// ==================== CLIENT USER (portal klienta) ====================

model ClientUser {
  id            String   @id @default(uuid())

  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])

  // Auth
  email         String
  phone         String?
  passwordHash  String

  // Profile
  name          String
  company       String?

  // Status
  isActive      Boolean  @default(true)
  emailVerified Boolean  @default(false)

  // Relations
  orders        Order[]  @relation("ClientOrders")
  comments      OrderComment[]
  refreshTokens ClientRefreshToken[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([tenantId, email])
  @@index([tenantId])
}

model ClientRefreshToken {
  id           String     @id @default(uuid())
  token        String     @unique
  clientUserId String
  clientUser   ClientUser @relation(fields: [clientUserId], references: [id], onDelete: Cascade)
  expiresAt    DateTime
  createdAt    DateTime   @default(now())

  @@index([clientUserId])
  @@index([expiresAt])
}

// ==================== ORDER ====================

model Order {
  id            String       @id @default(uuid())

  tenantId      String
  tenant        Tenant       @relation(fields: [tenantId], references: [id])

  orderNumber   String
  status        OrderStatus  @default(NEW)
  priority      OrderPriority @default(NORMAL)

  // Client info (from portal or manual entry)
  clientUserId  String?
  clientUser    ClientUser?  @relation("ClientOrders", fields: [clientUserId], references: [id])

  clientName    String?
  clientPhone   String?
  clientEmail   String?
  clientCompany String?

  // Details
  notes         String?
  internalNotes String?      // Niewidoczne dla klienta

  // Tracking
  createdById   String?
  createdBy     User?        @relation("CreatedByUser", fields: [createdById], references: [id])

  assignedToId  String?
  assignedTo    User?        @relation("AssignedToUser", fields: [assignedToId], references: [id])

  // Relations
  items         OrderItem[]
  comments      OrderComment[]
  attachments   Attachment[]
  statusHistory OrderStatusHistory[]

  // Dates
  dueDate       DateTime?
  completedAt   DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@unique([tenantId, orderNumber])
  @@index([tenantId, status, createdAt])
  @@index([clientUserId])
}

enum OrderStatus {
  NEW
  CONFIRMED
  IN_PROGRESS
  READY
  COMPLETED
  CANCELLED
}

enum OrderPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model OrderItem {
  id         String  @id @default(uuid())

  orderId    String
  order      Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId  String?
  product    Product? @relation(fields: [productId], references: [id])

  name       String
  quantity   Int     @default(1)
  unitPrice  Decimal @default(0) @db.Decimal(10, 2)
  totalPrice Decimal @default(0) @db.Decimal(10, 2)
  notes      String?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([orderId])
}

model OrderComment {
  id           String      @id @default(uuid())

  orderId      String
  order        Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Autor: albo ClientUser albo User (pracownik)
  clientUserId String?
  clientUser   ClientUser? @relation(fields: [clientUserId], references: [id])

  userId       String?
  // user      User?       @relation(fields: [userId], references: [id])

  content      String
  isInternal   Boolean     @default(false) // Wewnetrzne = niewidoczne dla klienta

  createdAt    DateTime    @default(now())

  @@index([orderId, createdAt])
}

model OrderStatusHistory {
  id         String      @id @default(uuid())

  orderId    String
  order      Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  fromStatus OrderStatus?
  toStatus   OrderStatus
  changedById String?
  reason     String?

  createdAt  DateTime    @default(now())

  @@index([orderId, createdAt])
}

// ==================== CUSTOMER ====================

model Customer {
  id          String   @id @default(uuid())

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  name        String
  phone       String?
  email       String?
  company     String?

  // Address
  address     String?
  city        String?
  postalCode  String?
  country     String   @default("PL")

  notes       String?
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, email])
  @@index([tenantId, phone])
}

// ==================== PRODUCT ====================

model Product {
  id          String   @id @default(uuid())

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  sku         String?
  name        String
  description String?

  price       Decimal  @default(0) @db.Decimal(10, 2)
  unit        String   @default("szt")

  isActive    Boolean  @default(true)

  // Relations
  orderItems  OrderItem[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, sku])
  @@index([tenantId])
}

// ==================== ATTACHMENT ====================

model Attachment {
  id           String   @id @default(uuid())

  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id])

  orderId      String?
  order        Order?   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  entityType   String?  // Order, Customer, etc.
  entityId     String?

  filename     String
  originalName String
  mimeType     String
  size         Int
  path         String

  uploadedById String?
  isInternal   Boolean  @default(false) // Wewnetrzne = niewidoczne dla klienta

  createdAt    DateTime @default(now())

  @@index([tenantId])
  @@index([orderId])
  @@index([entityType, entityId])
}
