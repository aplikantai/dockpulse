// DockPulse Tenant Database Schema
// This schema is the template for each tenant's isolated database (dockpulse_tenant_{slug})

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/tenant-client"
}

datasource db {
  provider = "postgresql"
  url      = env("TENANT_DATABASE_URL")
}

// ===========================================
// USERS (Employees of the tenant)
// ===========================================

model User {
  id           String    @id @default(uuid())
  email        String    @unique @db.VarChar(255)
  phone        String?   @db.VarChar(20)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  name         String    @db.VarChar(255)
  role         String    @db.VarChar(50) // 'admin' | 'manager' | 'employee'
  isActive     Boolean   @default(true) @map("is_active")
  settings     Json      @default("{}")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  orders        Order[]
  quotes        Quote[]
  assignedTasks Task[]

  @@map("users")
}

// ===========================================
// CUSTOMERS (Clients of the tenant)
// ===========================================

model Customer {
  id               String    @id @default(uuid())
  phone            String    @unique @db.VarChar(20) // Portal login
  passwordHash     String?   @map("password_hash") @db.VarChar(255) // Portal password
  email            String?   @db.VarChar(255)
  name             String    @db.VarChar(255)
  companyName      String?   @map("company_name") @db.VarChar(255)
  nip              String?   @db.VarChar(20)
  regon            String?   @db.VarChar(15)
  address          Json      @default("{}")
  deliveryAddress  Json?     @map("delivery_address")
  notes            String?   @db.Text
  tags             String[]  @default([])
  paymentTerms     String?   @map("payment_terms") @db.VarChar(50)
  creditLimit      Decimal?  @map("credit_limit") @db.Decimal(10, 2)
  discount         Decimal?  @db.Decimal(5, 2)
  priceList        String?   @map("price_list") @db.VarChar(50)
  isPortalActive   Boolean   @default(true) @map("is_portal_active")
  portalFirstLogin Boolean   @default(true) @map("portal_first_login")
  metadata         Json      @default("{}")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  orders   Order[]
  quotes   Quote[]
  messages Message[]

  @@index([phone])
  @@index([email])
  @@index([companyName])
  @@map("customers")
}

// ===========================================
// PRODUCTS / SERVICES
// ===========================================

model Product {
  id          String   @id @default(uuid())
  code        String?  @unique @db.VarChar(50)
  sku         String?  @db.VarChar(50)
  ean         String?  @db.VarChar(20)
  name        String   @db.VarChar(255)
  description String?  @db.Text
  category    String?  @db.VarChar(100)
  brand       String?  @db.VarChar(100)
  price       Decimal? @db.Decimal(10, 2)
  priceNet    Decimal? @map("price_net") @db.Decimal(10, 2)
  priceGross  Decimal? @map("price_gross") @db.Decimal(10, 2)
  vatRate     Decimal? @default(23) @map("vat_rate") @db.Decimal(5, 2)
  unit        String   @default("szt") @db.VarChar(20)
  weight      Decimal? @db.Decimal(10, 3)
  minOrder    Decimal? @map("min_order") @db.Decimal(10, 2)
  leadTime    Int?     @map("lead_time") // days
  isActive    Boolean  @default(true) @map("is_active")
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  stockItems StockItem[]

  @@index([code])
  @@index([category])
  @@index([isActive])
  @@map("products")
}

// ===========================================
// ORDERS
// ===========================================

model Order {
  id              String    @id @default(uuid())
  number          String    @unique @db.VarChar(50) // ZAM-2024-001
  customerId      String    @map("customer_id")
  userId          String?   @map("user_id")
  status          String    @db.VarChar(50)
  statusHistory   Json      @default("[]") @map("status_history")
  items           Json      @default("[]")
  subtotal        Decimal?  @db.Decimal(10, 2)
  discount        Decimal?  @db.Decimal(10, 2)
  totalAmount     Decimal?  @map("total_amount") @db.Decimal(10, 2)
  totalWeight     Decimal?  @map("total_weight") @db.Decimal(10, 3)
  notes           String?   @db.Text
  productionNotes String?   @map("production_notes") @db.Text
  deliveryDate    DateTime? @map("delivery_date") @db.Date
  deliveryAddress Json      @default("{}") @map("delivery_address")
  shippingMethod  String?   @map("shipping_method") @db.VarChar(50)
  trackingNumber  String?   @map("tracking_number") @db.VarChar(100)
  paymentStatus   String?   @map("payment_status") @db.VarChar(50)
  invoiceNumber   String?   @map("invoice_number") @db.VarChar(50)
  source          String    @default("admin") @db.VarChar(50) // 'admin' | 'portal' | 'api'
  metadata        Json      @default("{}")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [id])
  user     User?    @relation(fields: [userId], references: [id])
  quote    Quote?

  @@index([customerId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([deliveryDate])
  @@map("orders")
}

// ===========================================
// QUOTES
// ===========================================

model Quote {
  id          String    @id @default(uuid())
  number      String    @unique @db.VarChar(50)
  customerId  String    @map("customer_id")
  userId      String?   @map("user_id")
  status      String    @default("draft") @db.VarChar(50) // 'draft' | 'sent' | 'accepted' | 'rejected' | 'expired'
  items       Json      @default("[]")
  totalAmount Decimal?  @map("total_amount") @db.Decimal(10, 2)
  validUntil  DateTime? @map("valid_until") @db.Date
  notes       String?   @db.Text
  sentAt      DateTime? @map("sent_at")
  acceptedAt  DateTime? @map("accepted_at")
  rejectedAt  DateTime? @map("rejected_at")
  rejectReason String?  @map("reject_reason") @db.Text
  orderId     String?   @unique @map("order_id")
  metadata    Json      @default("{}")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [id])
  user     User?    @relation(fields: [userId], references: [id])
  order    Order?   @relation(fields: [orderId], references: [id])

  @@index([customerId])
  @@index([status])
  @@index([createdAt])
  @@map("quotes")
}

// ===========================================
// STOCK (Inventory)
// ===========================================

model StockItem {
  id           String   @id @default(uuid())
  productId    String   @map("product_id")
  locationId   String?  @map("location_id")
  quantity     Decimal  @default(0) @db.Decimal(10, 3)
  reserved     Decimal  @default(0) @db.Decimal(10, 3)
  available    Decimal  @default(0) @db.Decimal(10, 3)
  minStock     Decimal? @map("min_stock") @db.Decimal(10, 3)
  maxStock     Decimal? @map("max_stock") @db.Decimal(10, 3)
  lastCountAt  DateTime? @map("last_count_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  product  Product        @relation(fields: [productId], references: [id])
  location StockLocation? @relation(fields: [locationId], references: [id])

  @@unique([productId, locationId])
  @@index([productId])
  @@map("stock_items")
}

model StockLocation {
  id        String   @id @default(uuid())
  code      String   @unique @db.VarChar(50)
  name      String   @db.VarChar(100)
  type      String   @default("warehouse") @db.VarChar(50) // 'warehouse' | 'shelf' | 'bin'
  parentId  String?  @map("parent_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  stockItems StockItem[]
  parent     StockLocation?  @relation("LocationHierarchy", fields: [parentId], references: [id])
  children   StockLocation[] @relation("LocationHierarchy")

  @@map("stock_locations")
}

model StockMovement {
  id          String   @id @default(uuid())
  productId   String   @map("product_id")
  type        String   @db.VarChar(50) // 'in' | 'out' | 'transfer' | 'adjustment'
  quantity    Decimal  @db.Decimal(10, 3)
  fromLocation String? @map("from_location")
  toLocation   String? @map("to_location")
  reference   String?  @db.VarChar(100) // order number, etc.
  notes       String?  @db.Text
  userId      String?  @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([productId])
  @@index([type])
  @@index([createdAt])
  @@map("stock_movements")
}

// ===========================================
// TASKS
// ===========================================

model Task {
  id          String    @id @default(uuid())
  title       String    @db.VarChar(255)
  description String?   @db.Text
  status      String    @default("pending") @db.VarChar(50)
  priority    String    @default("normal") @db.VarChar(20) // 'low' | 'normal' | 'high' | 'urgent'
  dueDate     DateTime? @map("due_date")
  assignedTo  String?   @map("assigned_to")
  entityType  String?   @map("entity_type") @db.VarChar(50) // 'order' | 'customer' | ...
  entityId    String?   @map("entity_id")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  assignee User? @relation(fields: [assignedTo], references: [id])

  @@index([status])
  @@index([assignedTo])
  @@index([dueDate])
  @@map("tasks")
}

// ===========================================
// MESSAGES (Portal communication)
// ===========================================

model Message {
  id         String    @id @default(uuid())
  customerId String    @map("customer_id")
  direction  String    @db.VarChar(10) // 'in' | 'out'
  subject    String?   @db.VarChar(255)
  content    String    @db.Text
  isRead     Boolean   @default(false) @map("is_read")
  readAt     DateTime? @map("read_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  customer Customer @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([isRead])
  @@map("messages")
}

// ===========================================
// EVENT LOG (Audit Trail)
// ===========================================

model EventLog {
  id           String   @id @default(uuid())
  eventId      String   @map("event_id")
  eventType    String   @map("event_type") @db.VarChar(100)
  sourceModule String   @map("source_module") @db.VarChar(50)
  entityType   String?  @map("entity_type") @db.VarChar(50)
  entityId     String?  @map("entity_id")
  payload      Json     @default("{}")
  userId       String?  @map("user_id")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([eventType])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("event_log")
}

// ===========================================
// TENANT CONFIGURATION
// ===========================================

model TenantModule {
  id         String   @id @default(uuid())
  moduleCode String   @map("module_code") @db.VarChar(50)
  isEnabled  Boolean  @default(true) @map("is_enabled")
  config     Json     @default("{}")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@unique([moduleCode])
  @@map("tenant_modules")
}

model FieldConfig {
  id           String  @id @default(uuid())
  entityType   String  @map("entity_type") @db.VarChar(50) // 'customer' | 'order' | 'product'
  fieldName    String  @map("field_name") @db.VarChar(100)
  label        String? @db.VarChar(100)
  isVisible    Boolean @default(true) @map("is_visible")
  isRequired   Boolean @default(false) @map("is_required")
  displayOrder Int     @default(0) @map("display_order")

  @@unique([entityType, fieldName])
  @@map("field_configs")
}

model WorkflowTrigger {
  id           String   @id @default(uuid())
  code         String   @unique @db.VarChar(100)
  name         String   @db.VarChar(255)
  description  String?  @db.Text
  eventType    String   @map("event_type") @db.VarChar(100)
  actionType   String   @map("action_type") @db.VarChar(50) // 'sms' | 'email' | 'push' | 'webhook'
  actionConfig Json     @default("{}") @map("action_config")
  isEnabled    Boolean  @default(true) @map("is_enabled")
  createdAt    DateTime @default(now()) @map("created_at")

  @@map("workflow_triggers")
}

// ===========================================
// SETTINGS
// ===========================================

model TenantSetting {
  id        String   @id @default(uuid())
  key       String   @unique @db.VarChar(100)
  value     Json
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("tenant_settings")
}

// ===========================================
// NUMBER SEQUENCES
// ===========================================

model NumberSequence {
  id          String @id @default(uuid())
  entityType  String @unique @map("entity_type") @db.VarChar(50) // 'order' | 'quote' | 'customer'
  prefix      String @db.VarChar(10)
  currentYear Int    @map("current_year")
  lastNumber  Int    @default(0) @map("last_number")

  @@map("number_sequences")
}
