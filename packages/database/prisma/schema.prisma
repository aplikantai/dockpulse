// DockPulse Platform Database Schema
// This schema is for the shared platform database (dockpulse_platform)

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// TENANTS
// ===========================================

model Tenant {
  id        String   @id @default(uuid())
  slug      String   @unique @db.VarChar(50)
  name      String   @db.VarChar(255)
  template  String   @db.VarChar(50) // 'services' | 'production' | 'trade'
  planId    String?  @map("plan_id")
  status    String   @default("active") @db.VarChar(20) // 'active' | 'suspended' | 'deleted'
  settings  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  plan           Plan?           @relation(fields: [planId], references: [id])
  billingRecords BillingRecord[]

  @@map("tenants")
}

// ===========================================
// PLANS & BILLING
// ===========================================

model Plan {
  id           String   @id @default(uuid())
  name         String   @db.VarChar(100)
  priceMonthly Decimal? @map("price_monthly") @db.Decimal(10, 2)
  priceYearly  Decimal? @map("price_yearly") @db.Decimal(10, 2)
  features     Json     @default("{}")
  maxUsers     Int      @default(5) @map("max_users")
  maxCustomers Int      @default(1000) @map("max_customers")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  tenants        Tenant[]
  billingRecords BillingRecord[]

  @@map("plans")
}

model BillingRecord {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  planId      String   @map("plan_id")
  amount      Decimal  @db.Decimal(10, 2)
  periodStart DateTime @map("period_start") @db.Date
  periodEnd   DateTime @map("period_end") @db.Date
  status      String   @default("pending") @db.VarChar(20) // 'pending' | 'paid' | 'failed'
  invoiceUrl  String?  @map("invoice_url")
  createdAt   DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  plan   Plan   @relation(fields: [planId], references: [id])

  @@map("billing_records")
}

// ===========================================
// PLATFORM ADMINISTRATION
// ===========================================

model PlatformAdmin {
  id           String   @id @default(uuid())
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  name         String?  @db.VarChar(255)
  role         String   @default("admin") @db.VarChar(50) // 'superadmin' | 'admin' | 'support'
  isActive     Boolean  @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("platform_admins")
}

// ===========================================
// MODULE REGISTRY
// ===========================================

model ModuleRegistry {
  id             String   @id @default(uuid())
  code           String   @unique @db.VarChar(50) // '@customers' | '@orders' | ...
  name           String   @db.VarChar(100)
  description    String?  @db.Text
  templates      String[] @default([]) // which templates support this module
  defaultEnabled Boolean  @default(false) @map("default_enabled")
  configSchema   Json     @default("{}") @map("config_schema")
  displayOrder   Int      @default(0) @map("display_order")
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("module_registry")
}

// ===========================================
// GLOBAL SETTINGS
// ===========================================

model GlobalSetting {
  id        String   @id @default(uuid())
  key       String   @unique @db.VarChar(100)
  value     Json
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("global_settings")
}

// ===========================================
// AUDIT LOG (Platform Level)
// ===========================================

model PlatformAuditLog {
  id         String   @id @default(uuid())
  adminId    String?  @map("admin_id")
  action     String   @db.VarChar(100)
  entityType String?  @map("entity_type") @db.VarChar(50)
  entityId   String?  @map("entity_id")
  details    Json     @default("{}")
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
  @@map("platform_audit_log")
}
