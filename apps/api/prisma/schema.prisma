// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String   @id @default(uuid())
  slug      String   @unique
  name      String
  template  String   @default("services") // 'services' | 'production' | 'trade'
  branding  Json?
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users           User[]
  customers       Customer[]
  orders          Order[]
  quotes          Quote[]
  products        Product[]
  modules         TenantModule[]
  fieldConfigs    FieldConfig[]
  triggers        WorkflowTrigger[]
  eventLogs       EventLog[]

  @@map("tenants")
}

// ===========================================
// MODULE CONFIGURATION (per tenant)
// ===========================================

model TenantModule {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  moduleCode  String   // '@customers' | '@orders' | '@products' | '@quotes' | '@stock' | '@calendar' | etc.
  isEnabled   Boolean  @default(true)
  config      Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, moduleCode])
  @@index([tenantId])
  @@map("tenant_modules")
}

// ===========================================
// FIELD CONFIGURATION (per tenant, per entity)
// ===========================================

model FieldConfig {
  id           String   @id @default(uuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  entityType   String   // 'customer' | 'order' | 'product' | 'quote'
  fieldName    String   // e.g., 'phone', 'nip', 'deliveryAddress'
  isVisible    Boolean  @default(true)
  isRequired   Boolean  @default(false)
  displayOrder Int      @default(0)
  label        String?  // Custom label override
  config       Json     @default("{}")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([tenantId, entityType, fieldName])
  @@index([tenantId])
  @@index([entityType])
  @@map("field_configs")
}

// ===========================================
// WORKFLOW TRIGGERS (per tenant)
// ===========================================

model WorkflowTrigger {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  code        String   // e.g., 'order.new.sms_admin'
  name        String   // Human-readable name
  eventType   String   // 'order.created' | 'order.status_changed' | 'customer.created' | etc.
  actionType  String   // 'sms' | 'email' | 'webhook' | 'create_entity'
  actionConfig Json    @default("{}") // Template, recipient config, etc.
  conditions  Json     @default("{}") // When to trigger (status = 'ready', etc.)
  isEnabled   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  executions  WorkflowExecution[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([eventType])
  @@index([isEnabled])
  @@map("workflow_triggers")
}

// ===========================================
// EVENT LOG (audit trail per tenant)
// ===========================================

model EventLog {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventType   String   // 'order.created', 'order.status_changed', etc.
  entityType  String   // 'order', 'customer', 'product', 'quote'
  entityId    String
  userId      String?
  payload     Json     @default("{}")
  metadata    Json?    // Event metadata (version, correlationId, etc.)
  createdAt   DateTime @default(now())

  @@index([tenantId])
  @@index([eventType])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("event_logs")
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  name      String?
  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  role      String    @default("user")
  lastLogin DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  orders    Order[]
  quotes    Quote[]

  @@index([tenantId])
  @@map("users")
}

model Customer {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  email       String?
  phone       String?
  company     String?
  address     Json?
  notes       String?
  tags        String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orders      Order[]
  quotes      Quote[]

  @@index([tenantId])
  @@index([email])
  @@map("customers")
}

model Product {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  sku         String
  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  unit        String   @default("szt")
  category    String?
  stock       Int      @default(0)
  active      Boolean  @default(true)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orderItems  OrderItem[]
  quoteItems  QuoteItem[]

  @@unique([tenantId, sku])
  @@index([tenantId])
  @@map("products")
}

model Order {
  id          String      @id @default(uuid())
  tenantId    String
  tenant      Tenant      @relation(fields: [tenantId], references: [id])
  orderNumber String
  customerId  String
  customer    Customer    @relation(fields: [customerId], references: [id])
  userId      String?
  user        User?       @relation(fields: [userId], references: [id])
  status      String      @default("new")
  totalNet    Decimal     @db.Decimal(10, 2)
  totalGross  Decimal     @db.Decimal(10, 2)
  vatRate     Decimal     @default(23) @db.Decimal(5, 2)
  notes       String?
  metadata    Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  items       OrderItem[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([customerId])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id          String   @id @default(uuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  quantity    Int
  unitPrice   Decimal  @db.Decimal(10, 2)
  totalPrice  Decimal  @db.Decimal(10, 2)

  @@index([orderId])
  @@map("order_items")
}

model Quote {
  id          String      @id @default(uuid())
  tenantId    String
  tenant      Tenant      @relation(fields: [tenantId], references: [id])
  quoteNumber String
  customerId  String
  customer    Customer    @relation(fields: [customerId], references: [id])
  userId      String?
  user        User?       @relation(fields: [userId], references: [id])
  status      String      @default("draft")
  validUntil  DateTime?
  totalNet    Decimal     @db.Decimal(10, 2)
  totalGross  Decimal     @db.Decimal(10, 2)
  vatRate     Decimal     @default(23) @db.Decimal(5, 2)
  notes       String?
  metadata    Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  items       QuoteItem[]

  @@unique([tenantId, quoteNumber])
  @@index([tenantId])
  @@index([customerId])
  @@index([status])
  @@map("quotes")
}

model QuoteItem {
  id          String   @id @default(uuid())
  quoteId     String
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  quantity    Int
  unitPrice   Decimal  @db.Decimal(10, 2)
  totalPrice  Decimal  @db.Decimal(10, 2)

  @@index([quoteId])
  @@map("quote_items")
}

// ===========================================
// API KEYS (per tenant, for OpenRouter/AI services)
// ===========================================

model ApiKey {
  id          String   @id @default(uuid())
  tenantId    String
  name        String   // Company name / key name
  service     String   // 'openrouter' | 'openai' | 'anthropic' | etc.
  apiKey      String   // Encrypted API key
  isActive    Boolean  @default(true)
  usageCount  Int      @default(0)
  lastUsedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, service])
  @@index([tenantId])
  @@index([service])
  @@map("api_keys")
}

// ===========================================
// WORKFLOW EXECUTIONS (event-driven automation)
// ===========================================

model WorkflowExecution {
  id          String    @id @default(uuid())
  triggerId   String
  trigger     WorkflowTrigger @relation(fields: [triggerId], references: [id], onDelete: Cascade)
  tenantId    String
  eventId     String    // Reference to EventLog
  status      String    // 'SUCCESS' | 'FAILED' | 'PENDING'
  error       String?   // Error message if failed
  result      Json?     // Execution result
  executedAt  DateTime  @default(now())

  @@index([triggerId])
  @@index([tenantId])
  @@index([eventId])
  @@index([status])
  @@map("workflow_executions")
}
